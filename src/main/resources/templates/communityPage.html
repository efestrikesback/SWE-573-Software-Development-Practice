<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Community Details</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #navbar { background: #333; color: white; padding: 10px; }
    #navbar a { color: white; padding: 10px; text-decoration: none; }
    #navbar a:hover { background: #555; }
  </style>
  <script th:inline="javascript">
    function loadCommunityDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const communityId = urlParams.get('communityId');
      const token = localStorage.getItem('access_token');

      fetch(`/api/v1/community/${communityId}/details`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to load community details');
        return response.json();
      })
      .then(data => {
        document.getElementById('communityName').textContent = data.name;
        document.getElementById('communityDescription').textContent = data.description;

        if (data.owner) {
          document.getElementById('communityOwner').textContent = data.owner.username;
        } else {
          document.getElementById('communityOwner').textContent = 'Unknown';
        }

        const postsList = document.getElementById('postsList');
        postsList.innerHTML = '';
        if (data.posts) {
          data.posts.forEach(post => {
            const li = document.createElement('li');
            li.textContent = post.title;
            postsList.appendChild(li);
          });
        }

        checkMembershipStatus(communityId);
        loadCommunityMembers(communityId);  // Load members separately
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading community details: ' + error.message);
      });
    }

    function loadCommunityMembers(communityId) {
      const token = localStorage.getItem('access_token');

      fetch(`/api/v1/community/${communityId}/members`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to load community members');
        return response.json();
      })
      .then(members => {
        const membersList = document.getElementById('membersList');
        membersList.innerHTML = '';
        members.forEach(username => {
          const li = document.createElement('li');
          li.textContent = username;
          membersList.appendChild(li);
        });
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading community members: ' + error.message);
      });
    }

    function checkMembershipStatus(communityId) {
      const token = localStorage.getItem('access_token');

      fetch(`/api/v1/community/${communityId}/isMember`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(isMember => {
        const joinButton = document.getElementById('joinButton');
        const leaveButton = document.getElementById('leaveButton');

        if (isMember) {
          joinButton.textContent = 'You are already a member';
          joinButton.disabled = true;
          leaveButton.style.display = 'inline';
        } else {
          joinButton.textContent = 'Join Community';
          joinButton.disabled = false;
          leaveButton.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    function joinCommunity() {
      const urlParams = new URLSearchParams(window.location.search);
      const communityId = urlParams.get('communityId');
      const token = localStorage.getItem('access_token');

      fetch(`/api/v1/community/join/${communityId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to join community');
        return response.json();
      })
      .then(data => {
        alert('Successfully joined the community');
        checkMembershipStatus(communityId);
        loadCommunityMembers(communityId); // Reload members
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error joining community: ' + error.message);
      });
    }

    function leaveCommunity() {
      const urlParams = new URLSearchParams(window.location.search);
      const communityId = urlParams.get('communityId');
      const token = localStorage.getItem('access_token');

      fetch(`/api/v1/community/leave/${communityId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to leave community');
        alert('Successfully left the community');
        checkMembershipStatus(communityId);
        loadCommunityMembers(communityId); // Reload members
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error leaving community: ' + error.message);
      });
    }

    document.addEventListener('DOMContentLoaded', loadCommunityDetails);
  </script>
</head>
<body>
<div id="navbar">
  <a href="/mainPage">Main Page</a>
  <a href="/userProfile">Profile</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<h1 id="communityName">Community Name</h1>
<p id="communityDescription">Community Description</p>
<p><strong>Community Creator:</strong> <span id="communityOwner"></span></p>

<h2>Members</h2>
<ul id="membersList">
  <!-- Members will be populated here -->
</ul>

<h2>Posts</h2>
<ul id="postsList">
  <!-- Posts will be populated here -->
</ul>

<button id="joinButton" onclick="joinCommunity()">Join Community</button>
<button id="leaveButton" onclick="leaveCommunity()" style="display: none;">Leave Community</button>

<button onclick="window.location.href='/createPost?communityId=' + new URLSearchParams(window.location.search).get('communityId')">Create a Post</button>

<script>
    function logout() {
      localStorage.removeItem('access_token'); // Clear the stored token
      window.location.href = '/'; // Redirect to login page
    }
</script>
</body>
</html>

